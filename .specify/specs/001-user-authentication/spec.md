# 사용자 인증 시스템 스펙

## 개요

ChatZPT 서비스에서 사용자가 안전하게 로그인하고 서비스를 이용할 수 있도록 하는 사용자 인증 시스템을 구현합니다.

## 사용자 스토리

### US-001: 사용자 회원가입

**As a** 새로운 사용자  
**I want to** 이메일과 비밀번호로 계정을 생성할 수 있도록  
**So that** ChatZPT 서비스를 이용할 수 있다

**수용 기준:**

- [ ] 이메일 형식이 유효한지 검증한다
- [ ] 비밀번호는 최소 8자 이상, 영문, 숫자, 특수문자를 포함한다
- [ ] 중복된 이메일로는 가입할 수 없다
- [ ] 가입 성공 시 환영 메시지를 표시한다
- [ ] 가입 실패 시 구체적인 오류 메시지를 표시한다

### US-002: 사용자 로그인

**As a** 등록된 사용자  
**I want to** 이메일과 비밀번호로 로그인할 수 있도록  
**So that** 내 계정에 접근하여 AI 캐릭터와 대화할 수 있다

**수용 기준:**

- [ ] 올바른 이메일과 비밀번호로 로그인할 수 있다
- [ ] 잘못된 인증 정보로 로그인 시도 시 오류 메시지를 표시한다
- [ ] 로그인 성공 시 JWT 토큰을 발급한다
- [ ] 로그인 성공 시 대시보드로 리다이렉트한다
- [ ] 로그인 상태를 브라우저 세션에 유지한다

### US-003: 사용자 로그아웃

**As a** 로그인된 사용자  
**I want to** 로그아웃할 수 있도록  
**So that** 내 계정을 안전하게 종료할 수 있다

**수용 기준:**

- [ ] 로그아웃 버튼을 클릭하면 로그아웃된다
- [ ] 로그아웃 시 모든 세션 정보가 삭제된다
- [ ] 로그아웃 후 로그인 페이지로 리다이렉트된다
- [ ] 로그아웃 후 보호된 페이지에 접근할 수 없다

### US-004: 비밀번호 재설정

**As a** 사용자  
**I want to** 비밀번호를 잊었을 때 재설정할 수 있도록  
**So that** 계정에 다시 접근할 수 있다

**수용 기준:**

- [ ] 이메일을 입력하여 비밀번호 재설정 요청을 할 수 있다
- [ ] 등록된 이메일로 재설정 링크를 전송한다
- [ ] 재설정 링크는 24시간 후 만료된다
- [ ] 새 비밀번호 설정 시 기존 비밀번호와 달라야 한다
- [ ] 비밀번호 재설정 완료 시 로그인 페이지로 이동한다

## 기능 요구사항

### FR-001: 이메일 검증

- RFC 5322 표준에 따른 이메일 형식 검증
- 도메인 존재 여부 검증 (선택사항)
- 이메일 중복 검사

### FR-002: 비밀번호 정책

- 최소 8자 이상
- 영문 대소문자, 숫자, 특수문자 중 3가지 이상 포함
- 일반적인 비밀번호 패턴 차단 (예: "password", "12345678")

### FR-003: JWT 토큰 관리

- 액세스 토큰: 15분 만료
- 리프레시 토큰: 7일 만료
- 토큰 갱신 메커니즘
- 토큰 무효화 (로그아웃 시)

### FR-004: 세션 관리

- 브라우저 세션 스토리지 활용
- 자동 로그아웃 (장시간 비활성 시)
- 동시 세션 제한 (선택사항)

## 비기능 요구사항

### NFR-001: 보안

- 비밀번호 해싱: bcrypt 사용
- HTTPS 통신 강제
- CSRF 보호
- 레이트 리미팅: 분당 5회 로그인 시도 제한

### NFR-002: 성능

- 로그인 응답 시간: 200ms 이하
- 동시 로그인 사용자: 100명 이상 지원
- 데이터베이스 쿼리 최적화

### NFR-003: 사용성

- 로딩 상태 표시
- 명확한 오류 메시지
- 반응형 디자인
- 접근성 지원 (WCAG 2.1 AA)

## API 스펙

### POST /api/auth/register

```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "confirmPassword": "SecurePass123!"
}
```

**응답:**

```json
{
  "success": true,
  "message": "회원가입이 완료되었습니다",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

### POST /api/auth/login

```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**응답:**

```json
{
  "success": true,
  "message": "로그인 성공",
  "tokens": {
    "accessToken": "jwt_token",
    "refreshToken": "refresh_token"
  },
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}
```

### POST /api/auth/logout

**헤더:** Authorization: Bearer {accessToken}

**응답:**

```json
{
  "success": true,
  "message": "로그아웃 완료"
}
```

### POST /api/auth/forgot-password

```json
{
  "email": "user@example.com"
}
```

**응답:**

```json
{
  "success": true,
  "message": "비밀번호 재설정 링크가 이메일로 전송되었습니다"
}
```

### POST /api/auth/reset-password

```json
{
  "token": "reset_token",
  "newPassword": "NewSecurePass123!"
}
```

**응답:**

```json
{
  "success": true,
  "message": "비밀번호가 성공적으로 변경되었습니다"
}
```

## 데이터 모델

### User

```typescript
interface User {
  id: string; // UUID
  email: string; // 이메일 (unique)
  passwordHash: string; // 해시된 비밀번호
  createdAt: Date; // 생성일시
  updatedAt: Date; // 수정일시
  lastLoginAt?: Date; // 마지막 로그인 시간
  isActive: boolean; // 계정 활성화 상태
}
```

### RefreshToken

```typescript
interface RefreshToken {
  id: string; // UUID
  userId: string; // 사용자 ID
  token: string; // 리프레시 토큰
  expiresAt: Date; // 만료일시
  createdAt: Date; // 생성일시
}
```

## 보안 고려사항

1. **비밀번호 보안**

   - bcrypt로 해싱 (salt rounds: 12)
   - 평문 비밀번호 저장 금지

2. **토큰 보안**

   - JWT 시크릿 키는 환경변수로 관리
   - 토큰 만료 시간 적절히 설정
   - 리프레시 토큰은 데이터베이스에 저장

3. **입력 검증**

   - 모든 입력 데이터 검증 및 살균화
   - SQL 인젝션 방지
   - XSS 공격 방지

4. **로깅 및 모니터링**
   - 로그인 시도 로깅
   - 비정상적인 접근 패턴 모니터링
   - 보안 이벤트 알림

## 테스트 시나리오

### 단위 테스트

- [ ] 이메일 검증 함수 테스트
- [ ] 비밀번호 해싱 함수 테스트
- [ ] JWT 토큰 생성/검증 테스트
- [ ] 사용자 모델 유효성 검사 테스트

### 통합 테스트

- [ ] 회원가입 API 테스트
- [ ] 로그인 API 테스트
- [ ] 로그아웃 API 테스트
- [ ] 비밀번호 재설정 API 테스트

### E2E 테스트

- [ ] 전체 회원가입 플로우 테스트
- [ ] 로그인-로그아웃 플로우 테스트
- [ ] 비밀번호 재설정 플로우 테스트
- [ ] 보호된 페이지 접근 테스트

## 검토 및 수용 체크리스트

### 기능 검증

- [ ] 모든 사용자 스토리가 구현되었는가?
- [ ] API 엔드포인트가 올바르게 동작하는가?
- [ ] 데이터베이스 스키마가 올바른가?
- [ ] 프론트엔드와 백엔드가 올바르게 연동되는가?

### 보안 검증

- [ ] 비밀번호가 안전하게 해싱되는가?
- [ ] JWT 토큰이 올바르게 관리되는가?
- [ ] 입력 검증이 적절히 이루어지는가?
- [ ] 보안 헤더가 설정되어 있는가?

### 성능 검증

- [ ] 응답 시간이 요구사항을 만족하는가?
- [ ] 동시 사용자 처리가 가능한가?
- [ ] 데이터베이스 쿼리가 최적화되어 있는가?

### 사용성 검증

- [ ] 사용자 인터페이스가 직관적인가?
- [ ] 오류 메시지가 명확한가?
- [ ] 로딩 상태가 적절히 표시되는가?
- [ ] 반응형 디자인이 적용되어 있는가?
